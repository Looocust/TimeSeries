# En busca de los datos 



```{r setup, message=FALSE}
# Se instala lo necesario para proceder

library(tidyverse)   # dplyr, ggplot2, etc.
library(readxl)      # leer archivos .xlsx
library(lubridate)   # manejo de fechas
library(zoo)         # promedios móviles
library(forecast)    # funciones de series de tiempo

```

```{r cargar-datos}
# Leer la primera hoja (cámbiala con `sheet =` si hiciera falta)
retail <- read_excel("Online Retail 2.xlsx")

# Vistazo rápido a la estructura
dplyr::glimpse(retail)

```

```{r}
## --- 1. Agregar la cantidad por día ----------------------------------
# Aseguramos que 'InvoiceDate' sea fecha-hora y creamos la columna Date
retail <- retail %>% 
  mutate(Date = as.Date(InvoiceDate))

# Sumamos la cantidad vendida por día
daily_sales <- retail %>% 
  group_by(Date) %>% 
  summarise(TotalQty = sum(Quantity, na.rm = TRUE)) %>% 
  ungroup()

## --- 2. Gráfico base de la serie diaria ------------------------------
library(ggplot2)

ggplot(daily_sales, aes(Date, TotalQty)) +
  geom_line(color = "gray40") +
  labs(title = "Cantidad total vendida por día",
       x = "Fecha", y = "Total de unidades") +
  theme_minimal()

```

```{r}
library(dplyr)
library(zoo)

# Crear tabla con medias móviles
daily_ma <- daily_sales %>% 
  arrange(Date) %>% 
  mutate(
    MA_7  = zoo::rollmeanr(TotalQty,  7, fill = NA),
    MA_30 = zoo::rollmeanr(TotalQty, 30, fill = NA)
  )
names(daily_ma)

```

```{r}
library(ggplot2)

ggplot(daily_ma, aes(Date)) +
  geom_line(aes(y = TotalQty), colour = "grey70") +
  geom_line(aes(y = MA_7),  colour = "blue") +
  geom_line(aes(y = MA_30), colour = "red") +
  labs(title = "Promedios móviles de 7 y 30 días",
       y = "Total de unidades") +
  theme_minimal()
```
 La media móvil de 30 días (línea roja) muestra una tendencia ascendente clara desde mayo-2011, mientras que la de 7 días (azul) revela picos semanales.


```{r rezagos, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)

daily_lag <- daily_sales %>%               # usamos la tabla diaria original
  arrange(Date) %>% 
  mutate(
    Lag_1 = dplyr::lag(TotalQty, 1),
    Lag_7 = dplyr::lag(TotalQty, 7)
  )

```

```{r}
ggplot(daily_lag, aes(Date)) +
  geom_line(aes(y = TotalQty), colour = "black") +
  geom_line(aes(y = Lag_1), colour = "orange",  linetype = "dashed") +
  geom_line(aes(y = Lag_7), colour = "purple",  linetype = "dotted") +
  labs(title = "Serie comparada con rezagos de 1 y 7 días",
       y = "Total de unidades") +
  theme_minimal()

```
La superposición con el rezago de 1 día (naranja) indica alta autocorrelación diaria; el rezago-7 (morado) refuerza la periodicidad semanal.

```{r estacionalidad, message=FALSE, warning=FALSE}
library(forecast)   # ya lo tienes cargado
library(ggplot2)

# 1. Convertir la columna TotalQty en un objeto ts semanal
ts_qty <- ts(daily_sales$TotalQty, frequency = 7)

# 2. Descomponer con STL
decomp <- stl(ts_qty, s.window = "periodic")

# 3. Graficar los componentes
autoplot(decomp) +
  labs(title = "Descomposición STL: tendencia, estacionalidad y residuales")
```
El componente seasonal presenta oscilaciones regulares cada 7 puntos, confirmando efecto semanal; la tendencia suavizada muestra un crecimiento paulatino en la demanda.




